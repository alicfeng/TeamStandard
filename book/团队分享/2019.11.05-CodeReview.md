# CodeReview

本文由 **Martist** 提供分享 | [博客](http://www.martist.cn) | [GItHub](https://github.com/ma1203580780)

## 现状

Code Review 做得好的是一些比较偏技术的团队，而偏业务的技术团队基本上没有看到 Code Review 的记录。在业务团队不仅没有 Code Review，而且认为 Code Review 没用，因为：

```php
1）工期压得太紧，业务应用开发忙的跟狗一样，时间连coding都不够，以上线为目的

2）需求老变，代码的生命周期太短。所以，写好的代码没有任何意义，烂就烂吧，反正与绩效无关

3）而且业务逻辑变化快，通用性差，code review的成本要比底层高

4）Code Review是一种教条，意义不大，有测试，只要不出错，就可以了

5）现在的主要矛盾是倒排出来的工期和不靠谱的程序员之间的矛盾，我认为cr不是解决这个问题的银弹。不从实际情况出发光打正义的嘴炮实在太过于自慰了 。
```



## 工程师文化

Code Review 没用？我心里非常不认同这样的观点，我觉得我是程序员，我是工程师，就像医生一样，不是把病人医好就好了，还要对病人的长期健康负责。对于常见病，要很快地医好病人很简单，下猛药，大量使用抗生素，好得飞快。但大家都知道，这明显是 “饮鸩止渴”、“竭泽而渔” 的做法。医生需要有责任心和医德，我也觉得程序员工程师也要有相应的责任心和相应的修养。东西交给我我必须要负责，我觉得这种负责和修养不是” 做出来 “就了事了，而是要到 “做漂亮” 这个级别，这就是 “山寨” 和 “工业” 的差别。而只以 “做出来” 为目的标准，我只能以为，这样的做法只不过是 “按部就班” 的堆砌代码罢了，和劳动密集型的 “装配生产线” 和 “砌砖头” 没有什么差别，在这种环境里呆着还不如离开。



## 技术团队和业务团队的矛盾

我们可以看到，上面观点其实和 Code Review 没有太多关系，其实是在抱怨另外的问题。这些观点其实是技术团队和业务团队的矛盾，但不知道为什么强加给了我的 “Code Review 很重要” 的这个观点，然后这些观点反过来冲击 “Code Reivew”，并说 “Code Review 无用”。这种讨论问题的方式在很常见，你说 A，我说 B，本来 A、B 是两件事，但就是要混为一谈，然后似是而非的用 B 来证明你的 A 观点是错的。（也许，这些工程师 / 架构师心存怨气，需要一个发泄的通道）

我觉得，很多时候，人思考问题思考不清楚，很大一部分原因是因为把很多问题混为一谈，连我自己有些时候都会这样。引以为戒。

即然被混为一谈，那我就来拆分一下，也是下面这三个问题：

```php
Code Review有没有用的问题。

Code Review做不起来的问题。

业务变化快，速度快的问题，技术疲于跟命。
```



## 大师点评 Code Review

你 Google 一下 Code Reivew 这个关键词，你就会发现 Code Review 的好处基本上是不存在争议的，有很多很多的文章和博文都在说 Code Review 的重要性，怎么做会更好，而且很多公司在面试过程中会加入 “Code Review” 的问题。打开 Wikipedia 的词条你会看到这样的描述 ——

```php
卡珀斯·琼斯（Capers Jones）分析了超过12,000个软件开发项目，其中使用正式代码审查的项目，发现潜在缺陷率约在60-65%之间，若是非正式的代码审查，发现潜在缺陷率不到50%。大部分的测试，发现的潜在缺陷率会在30%左右。

对于一些关键的软件（例如安全关键系统的嵌入式软件），一般的代码审查速度约是一小时150行程序码，一小时审查数百行程序码的审查速度太快，可能无法找到程序中的问题。代码审查一般可以找到及移除约65%的错误，最高可以到85%。

也有研究针对代码审查找到的缺陷类型进行分析。代码审查找到的缺陷中，有75%是和计算机安全隐患有关。对于产品生命周期很长的软件公司而言，代码审查是很有效的工具。
```

Code Review 的好处我觉得不用多说了，主要是让你的代码可以更好的组织起来，有更易读，有更高的维护性，同时可以达到知识共享，找到 bug 只是其中的副产品。这个东西已经不新鲜了，你上网可以找到很多文章，我就不多说了。就像你写程序要判断错误一样，Code Review 也是最基本的常识性的东西。
我从 2002 年开始就浸泡在严格的 Code Review 中，我的个人成长和 Code Review 有很大的关系，如果我的成长过程中没有经历过 Code Review 这个事，我完全不敢想像。
我个人认为代码有这几种级别：1）可编译，2）可运行，3）可测试，4）可读，5）可维护，6）可重用。通过自动化测试的代码只能达到第 3）级，而通过 Code Review 的代码少会在第 4）级甚至更高。关于 Code Review，你可以参看本站的《Code Review 中的几个提示》
可见，Code Review 直接关系到了你的工程能力！



## Code Review 的问题

有下面几个情况会让你的 Code Review 没有效果。



### 人员能力不足

Code Review 的过程中，大家大眼瞪小眼，没有什么好的想法，不知道什么是好的代码，什么是不好的代码。导致 Code Review 大多数都在代码风格上。今天，我告诉你，代码风格这种事，是每个程序员自查的事情，不应该浪费大家的时间。对此，我有两个建议：

```php
1）你团队的人招错了，该换血了。

2）让你团队的人花时候阅读一下《代码大全》这本书（当然，还要读很多基础知识的书）。
```



### 结果更重要

做出来更重要，做漂亮不重要。因为我的 KPI 和年终奖 based on how many works I’ve done！而不是 How perfect they are ! 这让我想到那些天天在用 Spring MVC 做 CRUD 网页的工程师，我承认，他们很熟练。大量的重复劳动。其实，仔细想一下好多东西是可以框架化，模板化，或是自动生成的。所以，为了堆出这么多网页就停地去堆，做的东西是很多，但是没有任何成长。急功近利，也许，你做得多，拿到了不错的年终奖，但是你失去的也多，失去了成为一个卓越工程师的机会。你本来可以让你的月薪在 1-2 年后翻 1-2 倍的，但一年后你只拿到了为数不多的年终奖。



### 人员的态度问题

一方面就是懒，不想精益求精，只要干完活交差了事。对此，你更要大力开展 Code Review 了，让这种人写出来的代码曝光在更多人面前，让他为质量不好的代码蒙羞。另一方面，有人会觉得那是别人的模块，我不懂，也没时间 去懂，不懂他的业务怎么做 Code Review? 我只想说，如果你的团队里这样的 “各个自扫门前雪” 的事越多，那么这个团队也就越没主动性，没有主动性也就越不可能是个好团队，做的东西也不可能好。而对于个人来说，也就越不可能有成长。



### 需求变化的问题

有人认识，需求变得快，代码的生存周期比较短，不需要好的代码，反正过两天这些代码就会被废弃了。如果是一次性的东西，的确质量不需要太高，反正用了就扔。但是，我觉得多多少少要 Review 一下这个一次性的烂代码不会影响那些长期在用的代码吧，如果你的项目全部都是临时代码，那么你团队是不是也是一个临时团队？



### 时间不够问题

如果是业务逼得紧，让你疲于奔命，那么这不是 Code Review 好不好问题，这是需求管理和项目管理的问题以及别的非技术的问题。下面我会说。



## 被业务逼得太紧

被业务逼得太紧，需求乱变，如果你有足够的权限，再者提供一些解决思路。

- 重新定义产品主要目标和范围，确定哪些该做，哪些不该做
- 制定标准 ，API 都长得基本一样，并制订接入标准
- 推动重构，不再重复造轮子

这些事情推动起来并不容易，如果被业务方逼得紧，首先不要抱怨，你没有时间被逼得像牲口一样工作，这个时候，你需要的是暂停一下想一想，为什么会像牲口一样？而这正是让你变得聪明的机会。



## 总结一下



### 你有没有去 Review 业务部门给你的这么多的需求，哪些是合理的，哪些是不合理的

在 Amazon，开发工程师都会被教育拿到需求后一定要问 ——“为什么要做？业务影响度有多大？有多少用户受益？”，回答不清这个问题，没有数据的支持，就不做。所以，产品经理要做很多数据挖拙和用户调研的工作，而不是拍拍脑袋，听极少数的用户抱怨就要开需求了。



### 产品经理也要管理和教育的

你要告诉你的产品经理：“你是一个好的产品经理，因为你不但对用户把握得很好，也会对软件工艺把握得很好。你不但会开出外在的功能性需求，也同样会开出内在的让软件系统更完善的非功能性需求。你不是在迁就用户，而是引导用户。你不会无限制地加功能，而是把握产品灵魂控制并简化功能。你会为自己要做的和不做东西的感到同样的自豪。” 你要告诉你的产品经理：“做一个半成品不如做好半年产品”（更多这样的观点请参看《Rework 摘录和感想》）



### 做事情是要讲效率的

Amazon 里喜欢使用一种叫 T-Shirt Size Estimation 的评估方法来优先做投入小产出大的 “Happy Case”。关于什么是效率，什么是 T-Shirt Size Estimation，你可以看看《加班与效率》一文 。



### 需求总是会变化的，不要抱怨需求变化太快

你应该抱怨的是为什么我们没有把握好方向？老变？这个事就像踢足球一样，你要去的地方是球将要去的地方，而不是球现在的地方。你要知道球要去哪里，你就知道球之前是怎么动的，找到了运动轨迹后，你才知道球要去像何方。如果你都不知道球要去向何方，那你就是一只无头苍蝇一样，东一下西一下。

> 当你忙得跟牲口一样，你应该停下来，问一下自己，自己成为牲口的原因，是不是就是因为自己做事时候像就牲口一样思考？